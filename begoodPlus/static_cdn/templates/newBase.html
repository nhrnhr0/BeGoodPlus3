<!DOCTYPE html>
<html>

<head lang="he">
    {%load static %}
    {% load bootstrap5 %}

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>M.S. Global {% block head_title %}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link rel="stylesheet" href="{%static 'assets/css/jquery-ui.css'%}">
    <link rel="stylesheet" href="{%static 'assets/base/css/style.css'%}">
    {% block extra_head %}
    {% endblock %}
</head>

<body dir="rtl">
    {% block body %}

    <div class="icon-bar">
        <div class="icon delivery hide">
            <img src="{%static 'assets/base/imgs/delivery.svg'%}" alt="" srcset="">
            <div class="inner-icon">
                משלוח עד הבית
            </div>

        </div>
        <div class="icon whatsapp hide">
            <img src="{%static 'assets/base/imgs/whatsapp.svg' %}" alt="" srcset="">
            <a target="_blank" href="https://wa.me/+972547919908">
                <div class="inner-icon">
                    וואצאפ
                </div>
            </a>

        </div>
        <div class="icon facebook hide">
            <img src="{%static 'assets/base/imgs/icons8-facebook.svg'%}" alt="" srcset="">
            <a target="_blank"
                href="https://www.facebook.com/%D7%91%D7%99%D7%92%D7%95%D7%93-%D7%A4%D7%9C%D7%95%D7%A1-102693374827456/">
                <div class="inner-icon">
                    פייסבוק
                </div>
            </a>
        </div>

        <div class="icon instegram hide">
            <img src="{%static 'assets/base/imgs/instagram.svg'%}" alt="" srcset="">
            <a target="_blank" href="https://www.instagram.com/shermakdogs/">
                <div class="inner-icon">
                    אינסטגרם
                </div>
            </a>
        </div>
    </div>

    <!--
    {% if messages %}
    <div style="padding-top:50px;">
      <ul class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% endif %} alert-dismissible fade show"
          role="alert">
          <strong>{{message}}</strong>
        </div>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    -->
    <nav class="navbar navbar-expand-* navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{%url 'main-view'%}"><img class="nav-logo"
                    src="{%static 'assets/base/imgs/logo_ms.png'%}" alt="" height="58" width="24px"></a>

            <div class="menu-wraper">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">

                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="/test">דף הבית</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="/testCatalog">קטלוג</a>
                        </li>
                    </ul>
                </div>
            </div>


            <form class="d-flex" id="search_form">
                <input class="form-control" id="search" type="search" placeholder="Search" aria-label="Search">
                <!-- <button class="btn btn-outline-success" type="submit">Search</button>-->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <!--
                        <li class="nav-item">
                            <a class="nav-link nav-link-home active" aria-current="page" href="#">Home</a>
                        </li>
                        -->
                    <!--
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#">
                                <img width="25px" src="{%static 'assets/base/imgs/box.svg'%}" alt="" srcset="">
                            </a>
                        </li>
                        -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle show-count" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <!--
                                <img width="25px" src="{%static 'assets/base/imgs/email.svg' %}">
                                -->
                        </a>
                        <ul class="dropdown-menu" id="navbarDropdownList" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#">Action</a></li>
                            <li><a class="dropdown-item" href="#">Another action</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#">Something else here</a></li>
                        </ul>
                    </li>
                </ul>
            </form>



            <a class="navbar-brand" href="{%url 'main-view'%}"><img class="nav-logo-2"
                    src="{%static 'assets/base/imgs/begood_plus_logo.png'%}" alt="" height="58" width="24px"></a>




        </div>
    </nav>

    {%block content %} {%endblock content%}


    <footer id="footer">
        <div class="footer-top">
            <div class="container">

            </div>
        </div>

        <div class="container">
            <div class="copyright">
                © Copyright <strong>M.S. Global</strong>. All Rights Reserved
            </div>
            <div class="credits">
                Designed by <a href="https://ms-global.co.il/">M.S. Global</a>
            </div>
        </div>
    </footer>

    <!-- <script src="{%static 'assets/js/jquery.js'%}"></script> -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="{%static 'assets/js/jquery-ui.js'%}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script src="https://kit.fontawesome.com/022c0fea0b.js" crossorigin="anonymous"></script>
    <script src="{%static 'assets/base/js/base.js' %}"></script>
    
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        //var allAlbums = 
        /*
        var allAlbums;
        {%if catalogAlbumData %}
            allAlbums = {{catalogAlbumData|safe}};
            myStorage.setItem('msAlbums', JSON.stringify(allAlbums));
        {%else%}
            allAlbums = undefined;
        {%endif%}
        */
        var allAlbums;

        function getAllAlbums() {
            if (allAlbums == undefined) {
                allAlbums = JSON.parse(myStorage.getItem('msAlbums'));
                if (allAlbums == undefined) {
                    $.ajax({
                        type: "GET",
                        url: '/catalog_api',
                        success: (json) => {
                            //allAlbums = ;
                            myStorage.setItem('msAlbums', json.catalogAlbumData);
                        },
                        error: (e) => {
                            console.log('error:', e);
                        },
                        dataType: "json"
                    });
                }
            }
            console.log('getAllAlbums', allAlbums);
            return allAlbums;
        }
        var search_term_id = -1;

        function initAutocomplete() {
            $('#search').autocomplete({
                    source: function (request, response) {
                        console.log('request', request);
                        $.ajax({
                            url: "/search",
                            dataType: "json",
                            data: {
                                q: request.term
                            },
                            success: function (data) {
                                console.log('response', data);
                                /*var items = $.map(data.all, function (value, key) {
                                    console.log('map,', value, key)
                                    return {
                                        label: value.title,
                                        value: value.title,
                                        data: value
                                    };
                                });*/
                                search_term_id = data.id;
                                var items = [];
                                for (var i = 0; i < data.all.length; i++) {

                                    my_item = data.all[i];
                                    items.push({
                                        lable: my_item.title,
                                        value: my_item.title,
                                        data: my_item
                                    });
                                    // get the first album that is not all products
                                    var album = undefined;
                                    for (var k = 0; k < my_item.album.length; k++) {
                                        if (my_item.album[k].id != 1) {
                                            album = my_item.album[k]
                                            break;
                                        }
                                    }
                                    if (album == undefined) {
                                        album = my_item.album[0];
                                    }
                                    //album = my_item.album[1];
                                    var found_album = false;
                                    for (var j = 0; j < items.length; j++) {
                                        if (items[j].data.my_type == album.my_type && items[j].data.id ==
                                            album.id) {
                                            found_album = true;
                                            items[j].data.item_count += 1
                                            break;
                                        }
                                    }
                                    if (found_album == false) {
                                        items.unshift({
                                            lable: album.title,
                                            value: album.title,
                                            data: {
                                                id: album.id,
                                                title: album.title,
                                                my_type: album.my_type,
                                                url: album.url,
                                                item_count: 1,
                                            }
                                        });
                                    }
                                }
                                items.sort(function (a, b) {
                                    if (a.data.item_count > b.data.item_count) {
                                        return 1;
                                    } else if (a.data.item_count <= b.data.item_count) {
                                        return -1
                                    }
                                    return 0;
                                });
                                //response(data.all);
                                response(items);
                            },
                            error: function (xhr) {
                                alert('Request Status: ' + xhr.status + ' Status Text: ' + xhr
                                    .statusText + ' ' + xhr.responseText);
                            }
                        });
                    },
                    minLength: 2,
                    select: function (event, ui) {
                        var item = ui.item.data;
                        const csrftoken = getCookie('csrftoken');
                        $.ajax({
                            url: "/search-click",
                            dataType: "json",
                            type: "POST",
                            headers: {
                                'X-CSRFToken': csrftoken
                            },
                            data: {
                                id: search_term_id,
                                value: ui
                            },
                            success: function (data) {
                                console.log(data);
                            }
                        });


                        if (item.my_type == 'album') {
                            myStorage.setItem('search_open_category', item.id);
                        
                        }
                        else if (item.my_type == 'product') {
                            myStorage.setItem('search_open_product', item.id);
                            //window.location.href = item.url;
                        }

                        if (window.location.pathname != item.url) {
                            window.location.href = item.url;
                        } else {
                            handleSearchTasks();
                        }
                        console.log(ui.item ?
                            "Selected: " + ui.item.title :
                            "Nothing selected, input was " + this.value);
                    },
                })
                .autocomplete("instance")._renderItem = function (ul, item) {
            
                    console.log(item);
                    //console.log(ul.html());

                    var data = item.data;
                    if (data.my_type == 'album') {
                        return $(
                            `<li class="list-category" name="list-category-${data.id}"><div class="search-item" data-type='album' data-id='${data.id}'>${data.title} (${data.item_count})</div></li>`
                        ).prependTo(ul);
                    } else if (data.my_type == 'product') {
                        return $("<li>")
                            .append(
                                `<div class="search-item" data-type='product' data-id='${item.data.id}'><img style="height:25px;" src="${item.data.image}" /> ${item.data.title} </div>`
                            )
                            .appendTo(ul);
                    }
                    else if(data.my_type == 'mylogo_product') {
                        return $("<li>")
                            .append(
                                `<div class="search-item" data-type='product' data-id='${item.data.id}'><img style="height:25px;" src="${item.data.img}" /> ${item.data.title} </div>`
                            )
                            .appendTo(ul);
                    }else if(data.my_type == 'mylogo_album') {
                        return $(
                            `<li class="list-category" name="list-category-${data.id}"><div class="search-item" data-type='mylogo_album' data-id='${data.id}'>${data.title} (${data.item_count})</div></li>`
                        ).prependTo(ul);
                    }

                    /*
                    var album = item.data.images[1];
                    var category = ul.find(`li[name=list-category-${album.id}]`)[0];
                    if(category == undefined) {
                        category = $(`<li name="list-category-${album.id}"><div class="search-item" data-type='album' data-id='${album.id}'>${album.title}</div></li>`);
                        category.prependTo(ul);
                        //category = category.find('ul')
                    }
                    return $( "<li>" )
                            .append( `<div class="search-item" data-type='product' data-id='${item.value.id}'><img style="height:25px;" src="${item.data.image}" /> ${item.data.title} </div>`)
                            .appendTo(ul);
                    console.log(ul.html());
                    return ul;
                    */

                    /*
                    if(item.my_type == 'album') {
                        return $( "<li>" )
                            .append( `<div class="search-item" data-url="${item.url}" data-type='album' data-id='${item.id}'>  ${item.title} </div>`)
                            .appendTo( ul );
                    }else if(item.my_type == 'product') {
                        return $( "<li>" )
                            .append( `<div class="search-item" data-type='product' data-id='${item.id}'><img style="height:25px;" src="${item.image}" /> ${item.title} </div>`)
                            .appendTo( ul );
                    }else {
                        return ul;
                    }*/

                };
        }

        getAllAlbums();
        initAutocomplete();
    </script>

    {% block extra_body %}
    {% endblock %}
    {%endblock%}

</body>


</html>